

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  <meta content="index,follow" name="robots" />
<meta content="rbc documentation" name="description" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>RBC design principles &mdash; rbc 0.5.1+108.gb8e7a1f.dirty documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  
    <link rel="canonical" href="https://xnd.io/rbc/design.html"/>
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API Reference" href="api.html" />
    <link rel="prev" title="Remote Backend Compiler (rbc)" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/xndlogo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.5.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html"><em>Remote Backend Compiler (rbc)</em></a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#"><em>RBC</em> design principles</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#rbc-prototype-implementation">RBC prototype implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-usage">Example usage</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backends/index.html">Backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases/index.html">Releases</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">rbc</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html"><em>Remote Backend Compiler (rbc)</em></a> &raquo;</li>
        
      <li><em>RBC</em> design principles</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="rbc-design-principles">
<h1><em>RBC</em> design principles<a class="headerlink" href="#rbc-design-principles" title="Permalink to this headline">¶</a></h1>
<p>The basic idea of the <em>Remote Backend Compiler</em> is that the frontend
and backend components of a compiler run on two different hosts.</p>
<p>The input to the compiler frontend is a program source code and the
output is so-called Intermediate Representation (IR) that consists of
instructions that do not depend on the programming language used in
the program source code. Therefore, the IR form of the program code is
suitable for applying any optimization transformations prior
converting it to a machine code. The frontend component of a compiler
is run on a client machine.</p>
<p>The input to the compiler backend is the IR representation of the
program source code and the output is the machine code consisting of
instructions that a target processing unit (CPU or some accelerator
device such as GPU) will be executing.  The backend component of a
compiler is run on a server machine.</p>
<p>By IR we refer to LLVM IR or some of its clones (such as NVVM IR).
The frontend of the compiler needs to know what will be the target
processing unit. Hence, as a first step, the client must make a query
to the server for retrieving the information about the available
targets.</p>
<p>The backend of the compiler is built in to the server application
program that will compile the program in IR form recieved from the
client to machine code which will be loaded to server memory so that
the server process can execute the newly loaded programs. All this is
carried out in server application runtime.</p>
<p>The two tasks of compiling the client programs in IR form and
executing the loaded machine codes are considered as separate
tasks. In principle, there could be many clients: some clients submit
new programs to the server that will compile and load these to server
memory, and other clients make RPC calls to these new programs.</p>
<p>The following diagram summarizes the basic workflow of a RBC usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>+-------------------------------------------+
| Client 1                                  |
+-------------------------------------------+
| 1. define a task program:                 |
|         int foo(int a) {...}              |
| 2. request target information from Server |
| 3. compile the program to IR module:      |
|         i32 %foo(i32 %a) {...}            |
| 4. send the IR module to Server           |
+-------------------------------------------+

              +---------------------------------------------------+
              | Server                                            |
              +---------------------------------------------------+
              | 5.  recieve the IR module from Client 1           |
              | 6.  merge the IR module to a service IR module    |
              | 7.  compile the service IR module to machine code |
              | 8.  load the service machine code to memory       |
              | 9.  wait for clients tasks                        |
              |     ...                                           |
              | 12. recieve task parameters from Client 2         |
              |     and execute service instructions              |
              | 13. respond to Client 2 with service results      |
              +---------------------------------------------------+

       +------------------------------------------+
       | Client 2                                 |
       +------------------------------------------+
       | 10. define task parameter `a`            |
       | 11. send task (via RPC) to Server        |
       |     ...                                  |
       | 14. recieve service results from Server  |
       | 15. process the results..                |
       +------------------------------------------+
</pre></div>
</div>
<div class="section" id="rbc-prototype-implementation">
<h2>RBC prototype implementation<a class="headerlink" href="#rbc-prototype-implementation" title="Permalink to this headline">¶</a></h2>
<p>To implement a prototype of a RBC application, we’ll use Python
language. The client task functions are Python functions. For LLVM IR
and machine code generation, we’ll use numba and llvmlite Python
packages. For RPC, we’ll use thriftpy2 package.</p>
</div>
<div class="section" id="example-usage">
<h2>Example usage<a class="headerlink" href="#example-usage" title="Permalink to this headline">¶</a></h2>
<p>First, we’ll run the Server:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File: rbc_server.py</span>
<span class="kn">import</span> <span class="nn">rbc</span>

<span class="k">class</span> <span class="nc">Dispatcher</span><span class="p">(</span><span class="n">rbc</span><span class="o">.</span><span class="n">thrift</span><span class="o">.</span><span class="n">Dispatcher</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_prototype</span><span class="p">,</span> <span class="n">task_ir</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="o">...</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_name</span><span class="p">,</span> <span class="n">task_arguments</span><span class="p">):</span>
        <span class="n">task_ptr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">get_function_address</span><span class="p">(</span><span class="n">task_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">task_ptr</span><span class="p">,</span> <span class="n">task_arguments</span><span class="p">)</span>

<span class="n">rbc</span><span class="o">.</span><span class="n">thrift</span><span class="o">.</span><span class="n">Server</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">Dispatcher</span><span class="p">,</span>
                      <span class="s1">&#39;/path/to/rbc.thrift&#39;</span><span class="p">,</span>
                      <span class="n">host</span><span class="o">=...</span><span class="p">,</span> <span class="n">port</span><span class="o">=...</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Next, for simplicity, we implement Client 1 and Client 2
functionalities in one Python script:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File: rbc_client.py</span>

<span class="kn">import</span> <span class="nn">rbc</span>

<span class="c1"># Client 1 functionality:</span>

<span class="nd">@rbc</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">host</span><span class="o">=...</span><span class="p">,</span> <span class="n">port</span><span class="o">=...</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">a</span> <span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c1"># Client 2 functionality:</span>

<span class="n">a</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">foo</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="c1"># or</span>

<span class="n">foo</span> <span class="o">=</span> <span class="n">rbc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="n">host</span><span class="o">=...</span><span class="p">,</span> <span class="n">port</span><span class="o">=...</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">foo</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;foo(</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1">) -&gt; </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="api.html" class="btn btn-neutral float-right" title="API Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Remote Backend Compiler (rbc)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2021, Xnd-Project
      <span class="lastupdated">
        Last updated on True.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>